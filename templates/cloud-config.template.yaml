#cloud-config
timezone: Europe/Berlin

users:
  - name: chesskeeper
    shell: /bin/bash
    groups: [sudo, docker]
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - __SSH_KEY__

package_update: true
package_upgrade: true
packages:
  - curl
  - git
  - make
  - docker.io
  - docker-compose-plugin
  - fail2ban
  - ufw

write_files:
  - path: /etc/motd
    content: |
      Welcome to Chesskeeper Node!

runcmd:
  # SSH + Sicherheit (Hetzner-Empfehlung)
  - printf "[sshd]\nenabled = true\nbanaction = iptables-multiport" > /etc/fail2ban/jail.local
  - systemctl enable fail2ban
  - ufw allow 2222
  - ufw allow 80
  - ufw allow 443
  - ufw enable
  - sed -i -e '/^\(#\|\)PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)PasswordAuthentication/s/^.*$/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)Port/s/^.*$/Port 2222/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)KbdInteractiveAuthentication/s/^.*$/KbdInteractiveAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)ChallengeResponseAuthentication/s/^.*$/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)MaxAuthTries/s/^.*$/MaxAuthTries 2/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowTcpForwarding/s/^.*$/AllowTcpForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)X11Forwarding/s/^.*$/X11Forwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AllowAgentForwarding/s/^.*$/AllowAgentForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^\(#\|\)AuthorizedKeysFile/s/^.*$/AuthorizedKeysFile .ssh\/authorized_keys/' /etc/ssh/sshd_config
  - sed -i '$a AllowUsers chesskeeper' /etc/ssh/sshd_config
  - systemctl restart sshd

  # Chesskeeper Setup
  - git clone https://github.com/14code/chesskeeper-infra.git /opt/chesskeeper
  - cd /opt/chesskeeper && DOMAIN=__DOMAIN__ SSH_KEY="__SSH_KEY__" LABEL=__LABEL__ bash scripts/configure.sh
  - cd /opt/chesskeeper && scripts/prepare-volume.sh
